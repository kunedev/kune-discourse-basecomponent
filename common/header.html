<!------------------------  THIS BLOCK MAKES KUNE DIVS AVAILABLE TO JS          --------------------------------->

<!-- 
refs:
https://meta.discourse.org/t/a-new-versioned-api-for-client-side-plugins/40051
https://meta.discourse.org/t/using-the-pluginapi-in-site-customizations/41281 >
https://regex101.com/r/rOHmo8/1
https://meta.discourse.org/t/a-tour-of-how-the-widget-virtual-dom-code-in-discourse-works/40347
learn about loadscript 
-->


<!-- global custom fields -->

<script type='text/x-handlebars' data-template-name='/connectors/above-site-header/kune-config'>
    <div id='k-above-site-header'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/below-site-header/kune-config'>
    <div id='k-below-site-header'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/above-main-container/kune-config'>
    <div id='k-above-main-container'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/top-notices/kune-config'>
    <div id='k-top-notices'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/above-footer/kune-config'>
    <div id='k-above-footer'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/below-footer/kune-config'>
    <div id='k-below-footer'></div>
</script>

<!-- homepage and category pages / custom fields -->

<script type='text/x-handlebars' data-template-name='/connectors/discovery-list-controls-above/kune-config'>
    <div id='k-discovery-list-controls-above'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/extra-nav-item/kune-config'>
    <div id='k-extra-nav-item'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/discovery-list-container-top/kune-config'>
    <div id='k-discovery-list-container-top'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/after-topic-list/kune-config'>
    <div id='k-after-topic-list'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/discovery-below/kune-config'>
    <div id='k-discovery-below'></div>
</script>

<!-- topic pages / custom fields -->

<script type='text/x-handlebars' data-template-name='/connectors/topic-above-post-stream/kune-config'>
    <div id='k-topic-above-post-stream'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-category/kune-config'>
    <div id='k-topic-category'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-title/kune-config'>
    <div id='k-topic-title'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-above-posts/kune-config'>
    <div id='k-topic-above-posts'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-above-footer-buttons/kune-config'>
    <div id='k-topic-above-footer-buttons'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-footer-main-buttons-before-create/kune-config'>
    <div id='k-topic-footer-main-buttons-before-create'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/after-topic-footer-buttons/kune-config'>
    <div id='k-after-topic-footer-buttons'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-above-suggested/kune-config'>
    <div id='k-topic-above-suggested'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/below-suggested-topics/kune-config'>
    <div id='k-below-suggested-topics'></div>
</script>

<!-- group pages / custom fields -->

<script type='text/x-handlebars' data-template-name='/connectors/group-details-after/kune-config'>
    <div id='k-group-details-after'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/group-reports-nav-item/kune-config'>
    <div id='k-group-reports-nav-item'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/after-d-editor/kune-config'>
    <div id='k-after-d-editor'></div>
</script>

<!-- end of custom fields -->
<!------------------------  END OF MAKING KUNE DIVS AVAILABLE TO JS          --------------------------------->


<!--  SCRIPT MANAGING DYNAMIC CONTENT   -->

<script type="text/discourse-plugin" version="0.1">

const settings = Discourse.SiteSettings,
    taggingEnabled = settings.tagging_enabled,
    title = settings.title;

  if (taggingEnabled) {
    console.log("Yay! "+title+" has tagging enabled!")
  } else {
    console.log("Ohh nooos! "+title+"Does not allow tagging.")
  }


    api.decorateCooked($elem => $elem.css({ backgroundColor: 'yellow' }));
    
    api.onPageChange((url, title) => { 
      console.log('user navigated! ' + url);
  
      var blnIsCategory = false;
      var blnIsTopic = false;
      var blnIsGroup = false; 
      var blnIsHomepage = false; 
      var strHomepageView = "";
      
      // ---------- homepage check  ------------
      
      if (url == "/")   {                // if there's no match for this pattern then there is nothing after the ".com/" (or other tld)
         blnIsHomepage = true;
         strHomepageView = "home";
      }
      
      if (url == "/latest") {
         blnIsHomepage = true;
         strHomepageView = "latest";
      }
      if (url == "/categories") {
         blnIsHomepage = true;
         strHomepageView = "categories";
      }
      if (url == "/top") {
         blnIsHomepage = true;
         strHomepageView = "top";
      }
      
      // ---------- end of homepage check  ------------
  
      // ---------- other pagetype checks  ------------
  
      var res = url.match(/\/t\/(.*?)\/(\w+)/);       // check for topic id
      if (res && res[2] > 0) {
          console.log("topic " + res[2]);
          var blnIsTopic = true;
          var thisTopicID = res[2];
      }
  
      console.log("about to check url " + url);
      var res = url.match(/(\/g)\/(\w+)/);      // check for group id
      if (res !== null) {
          var blnIsGroup = true;
          var thisGroupName = res[2];
          console.log("Is group. " + thisGroupName);
      }
   
      var res = url.match(/\/c\/(.*?)\/(\d+)/);       // category page check: check for category id position 2
      if (res && res[2] > 0) {
          var blnIsCategory = true;
          var thisCategoryID = res[2];
      }
   
      var res = url.match(/\/c\/(.*?)\/(\w+)\/(\d+)/);       // category page check:  check for category id  position 3
      if (res && res[3] > 0) {
          var blnIsCategory = true;
          var thisCategoryID = res[3];
      }
  
      var res = url.match(/\/c\/(.*?)\/(\w+)\/(\w+)\/(\d+)/);       // category page check:  check for category id  position 4
      if (res && res[4] > 0) {
          var blnIsCategory = true;
          var thisCategoryID = res[4];
      }
  
      // ---------- end of other pagetype checks  ------------
      
      // nb the common all-page items don't get reset per page afaik 
  
      var kCustomSidebar = document.getElementById('ksidebardiv');
      
      var kCustomTopicField = document.getElementsByClassName('topic-title-custom-field-container')[0];
      var kCustomCategoryField = document.getElementsByClassName('category-custom-field-textarea')[0];
  
      var kTargetTopicField = document.getElementById('k-topic-above-suggested');
      var kTargetCategoryField = document.getElementById('k-discovery-below');
      
  
      if (blnIsCategory) {
          
              document.getElementById('k-discovery-list-controls-above').innerHTML = "";     // emptying it because it may have been set by Homepage. 
              document.getElementById('k-discovery-list-container-top').innerHTML = "";     // emptying it because it may have been set by Homepage. 
              // reset other shared fields also 
              // no need to reset where they are set by a subsequent line below 
  
              console.log("category " + thisCategoryID);
              var main = document.getElementById('k-discovery-list-container-top');
              var externalHTML = url + " :  Category id: " + thisCategoryID ;
              main.innerHTML = externalHTML;
              
              if (kCustomSidebar !== null) {
                  kCustomSidebar.innerHTML = externalHTML;
              }
  
                         
              kTargetCategoryField.innerHTML = kCustomCategoryField.innerHTML;    // for demo purposes: show custom field here.
              
  
          var kCustomTopicField = document.getElementsByClassName('topic-title-custom-field-container')[0];
          var kTargetTopicField = document.getElementById('topic-above-suggested');
          
      
      } else if (blnIsHomepage) {      //  NB this is closely related to 
  
              document.getElementById('k-discovery-list-controls-above').innerHTML = "";     // emptying it because it may have been set by Category page. 
              document.getElementById('k-discovery-list-container-top').innerHTML = "";     // emptying it because it may have been set by Category page. 
              // reset other shared fields also 
              // no need to reset where they are set by a subsequent line below 
  
              var main = document.getElementById('k-discovery-list-controls-above');
              var externalHTML = url + " Homepage type: " + strHomepageView ;
              main.innerHTML = externalHTML;
              
              if (kCustomSidebar !== null) {
                  kCustomSidebar.innerHTML = externalHTML;
              }
              
      } else if (blnIsTopic) {
              const main = document.getElementById('k-topic-title');
              const externalHTML = url + " :  Topic id: " + thisTopicID ;
              main.innerHTML = externalHTML;
              
              if (kCustomSidebar !== null) {
                  kCustomSidebar.innerHTML = externalHTML;
              }
              
              kTargetTopicField.innerHTML = kCustomTopicField.innerHTML;  // test .. apply content of custom field to another text holder
              
      } else if (blnIsGroup) {    // currently not being set as true at all 
              const main = document.getElementById('k-group-reports-nav-item');
              main.innerHTML = thisGroupName;
              
              
      } else {    // some other page
          
      }
   
    })
  
  
   </script> // opposite end of "commenting out"