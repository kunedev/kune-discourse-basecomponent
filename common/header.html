
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>  <!--  testing / does it fix issues? --> 


<!--   PROOF OF CONCEPT OF 
							A) READING SETTINGS THAT ARE SET VIA HEADER ON MAIN THEME   
							B) ASSIGNING THIS TO 2 VARIABLES, IN i) JS and ii) DISCOURSE/TEXT THEN
							C) REUSING THOSE VARIABLES LATER IN JS, AND DISCOUSE/TEXT, RESPECTIVELY 				--> 

	<script>		// poc only
		var kSettingsDivReader = document.getElementById('kSettings');		
		const kSettingsJS = kSettingsDivReader.innerHTML;       // demo of how to retrieve custom settings. 

		const kSettingsJSON = JSON.parse(kSettingsJS);
		console.log("Community Ref: " + kSettingsJSON.CommunityRef);
		console.log("OtherSettingsArray[2].name : " + kSettingsJSON.OtherSettingArray[2].name);
		
        //        function SayHello(){                  alert("Hello");           }

	</script>

	<script type="text/discourse-plugin" version="0.1">	// poc only
		console.log (kSettingsJS + "  -  script (text/discourse) .. this proves the JS variable is available within TEXT/DISCOURSE .. ULTRACOOL!");		 // this proves that the JS variable remains available 
		console.log("Community EntityID (from text/discourse): " + kSettingsJSON.EntityID);

	</script>



<!--   END OF PROOF OF CONCEPT REF SETTINGS ETC  --> 

<!-- Font awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />

<!-- support fomantic-ui messaging   -->
<link rel="stylesheet" type="text/css" href="https://empowercdn.com/libs/fomantic/fomantic-ui-2.8.8.-semantic-kune-modified.min.css" />  

<script src="https://empowercdn.com/libs/fomantic/fomantic-ui-2.8.8-dist-semantic-kunemod.min.js?v=00122"></script>
<!-- note: that ^^ is a minified version of a kune-specific modified version. see the non-minified version for comments -->


<!-- standard leaflet css -->
<link rel="stylesheet" type="text/css" href="https://empowercdn.com/libs/leaflet/leaflet-v1.7.1.css" />
<script src="https://empowercdn.com/libs/leaflet/leaflet-v1.7.1.js"></script>

<!-- top menu placeholder NB NB  removed for now    -->
<div id="topmenubar" class = "navbar-collapse wrap">    </div>    

<!-- top of page content content   NB NB  removed for now     -->

<script src="https://empowercdn.com/include/discourse-wecanireland-topmenubar.js?version=00040"></script>

    <script src='https://empowercdn.com/geo/level2/ie3.js?ver=1.0.6'></script>
	<script src='https://empowercdn.com/include/leaflet-inourcare-geodata.js?ver=1.0.6'></script>
	<script src='https://empowercdn.com/include/leaflet-setmap-inourcare-demo.js?ver=1.0.13' ></script>
	<script src='https://empowercdn.com/include/leaflet-inourcare-add.js?ver=1.0.14' ></script>            



<!------------------------   END OF THE ORIGINAL CODE FROM WECANIRELAND.          --------------------------------->



<!------------------------  THIS BLOCK MAKES KUNE DIVS AVAILABLE TO JS          --------------------------------->

<!-- 
refs:
https://meta.discourse.org/t/a-new-versioned-api-for-client-side-plugins/40051
https://meta.discourse.org/t/using-the-pluginapi-in-site-customizations/41281 >
https://regex101.com/r/rOHmo8/1
https://meta.discourse.org/t/a-tour-of-how-the-widget-virtual-dom-code-in-discourse-works/40347
learn about loadscript 
-->


<!-- global custom fields -->

<script type='text/x-handlebars' data-template-name='/connectors/above-site-header/kune-config'>
    <div id='k-above-site-header'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/below-site-header/kune-config'>
    <div id='k-below-site-header'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/above-main-container/kune-config'>
    <div id='k-above-main-container'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/top-notices/kune-config'>
    <div id='k-top-notices'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/above-footer/kune-config'>
    <div id='k-above-footer'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/below-footer/kune-config'>
    <div id='k-below-footer'></div>
</script>

<!-- homepage and category pages / custom fields -->

<script type='text/x-handlebars' data-template-name='/connectors/discovery-list-controls-above/kune-config'>
    <div id='k-discovery-list-controls-above'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/extra-nav-item/kune-config'>
    <div id='k-extra-nav-item'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/discovery-list-container-top/kune-config'>
    <div id='k-discovery-list-container-top'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/after-topic-list/kune-config'>
    <div id='k-after-topic-list'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/discovery-below/kune-config'>
    <div id='k-discovery-below'>DemoTextForNow</div>
</script>

<!-- topic pages / custom fields -->

<script type='text/x-handlebars' data-template-name='/connectors/topic-above-post-stream/kune-config'>
    <div id='k-topic-above-post-stream'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-category/kune-config'>
    <div id='k-topic-category'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-title/kune-config'>
    <div id='k-topic-title'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-above-posts/kune-config'>
    <div id='k-topic-above-posts'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-above-footer-buttons/kune-config'>
    <div id='k-topic-above-footer-buttons'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-footer-main-buttons-before-create/kune-config'>
    <div id='k-topic-footer-main-buttons-before-create'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/after-topic-footer-buttons/kune-config'>
    <div id='k-after-topic-footer-buttons'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/topic-above-suggested/kune-config'>
    <div id='k-topic-above-suggested'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/below-suggested-topics/kune-config'>
    <div id='k-below-suggested-topics'></div>
</script>

<!-- group pages / custom fields -->

<script type='text/x-handlebars' data-template-name='/connectors/group-details-after/kune-config'>
    <div id='k-group-details-after'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/group-reports-nav-item/kune-config'>
    <div id='k-group-reports-nav-item'></div>
</script>

<script type='text/x-handlebars' data-template-name='/connectors/after-d-editor/kune-config'>
    <div id='k-after-d-editor'></div>
</script>

<!-- end of custom fields -->

<!------------------------  END OF MAKING KUNE DIVS AVAILABLE TO JS          --------------------------------->


<!--  SCRIPT MANAGING DYNAMIC CONTENT   -->

<script type="text/discourse-plugin" version="0.8.7">

    console.log(api.h('b', ['hello', 'world']));


  //  console.log(this);        // kept, as reference / reminder. 

  /*        // all this is working 
        const siteSettings = Discourse.SiteSettings,
            taggingEnabled = siteSettings.tagging_enabled,
            title = siteSettings.title;

        if (taggingEnabled) {     
            console.log("Yay! "+title+" has tagging enabled!")
        } else {
            console.log("Ohh nooos! "+title+"Does not allow tagging.")
        }

        const kCommunity = settings.kcommunity;       // demo of how to retrieve *custom* settings. 
        console.log("kcommunity : " + kCommunity);
         
        SayHello();  // test invocation within "text/discourse-plugin" of a JS function declared earlier on page.

  */ 

   //  api.decorateCooked($elem => $elem.css({ backgroundColor: '#e9f0ec' }));            // change to a variable 
   

    api.onPageChange((url, title) => { 
      console.log('user navigated! ' + url);
  
      console.log("");                            // CHECK LATER SHOULD I BE REFRESHING ON EACH PAGE LOAD? .. SEEMS OTT .. WOULD IT WORK ONCE-OFF?
        console.log("siteSettings");
        const siteSettings = api.container.lookup("site-settings:main");
        console.log(siteSettings);
        console.log("");
        console.log("Site");
        const Site = api.container.lookup("service:site");
        console.log(Site);
        console.log("");
        console.log("currentUser");
        const currentUser =  api.getCurrentUser();
        console.log(currentUser);
        console.log(""); 

        console.log("categoriesById:");     // make this easily available 
        const categoriesById = Site.categoriesById;
        console.log(categoriesById);
        console.log("");

        var blnIsCategory = false;
        var blnIsTopic = false;
        var blnIsGroup = false; 
        var blnIsHomepage = false; 
        var strHomepageView = "";
        
      // ---------- homepage check  ------------
      
      if (url == "/")   {                // if there's no match for this pattern then there is nothing after the ".com/" (or other tld)
         blnIsHomepage = true;
         strHomepageView = "home";
      }
      
      if (url == "/latest") {
         blnIsHomepage = true;
         strHomepageView = "latest";
      }
      if (url == "/categories") {
         blnIsHomepage = true;
         strHomepageView = "categories";
      }
      if (url == "/top") {
         blnIsHomepage = true;
         strHomepageView = "top";
      }
      
      // ---------- end of homepage check  ------------
  
      // ---------- other pagetype checks  ------------
  
      var res = url.match(/\/t\/(.*?)\/(\w+)/);       // check for topic id
      if (res && res[2] > 0) {
          console.log("topic " + res[2]);
          var blnIsTopic = true;
          var thisTopicID = res[2];
      }
  
      console.log("about to check url " + url);
      var res = url.match(/(\/g)\/(\w+)/);      // check for group id
      if (res !== null) {
          var blnIsGroup = true;
          var thisGroupName = res[2];
          console.log("Is group. " + thisGroupName);
      }
   
      var res = url.match(/\/c\/(.*?)\/(\d+)/);       // category page check: check for category id position 2
      if (res && res[2] > 0) {
          var blnIsCategory = true;
          var thisCategoryID = res[2];
      }
   
      var res = url.match(/\/c\/(.*?)\/(\w+)\/(\d+)/);       // category page check:  check for category id  position 3
      if (res && res[3] > 0) {
          var blnIsCategory = true;
          var thisCategoryID = res[3];
      }
  
      var res = url.match(/\/c\/(.*?)\/(\w+)\/(\w+)\/(\d+)/);       // category page check:  check for category id  position 4
      if (res && res[4] > 0) {
          var blnIsCategory = true;
          var thisCategoryID = res[4];
      }
  
      // ---------- end of other pagetype checks  ------------
      
      // nb the common all-page items don't get reset per page afaik 
  
      var kCustomSidebar = document.getElementById('ksidebardiv');
        
      if (blnIsCategory) {
          
              document.getElementById('k-discovery-list-controls-above').innerHTML = "";     // emptying it because it may have been set by Homepage. 
              document.getElementById('k-discovery-list-container-top').innerHTML = "";     // emptying it because it may have been set by Homepage. 
              // reset other shared fields also 
              // no need to reset where they are set by a subsequent line below 
  
        /*      console.log("category " + thisCategoryID);
              var main = document.getElementById('k-discovery-list-container-top');
              var externalHTML = url + " :  Category id: " + thisCategoryID ;
              main.innerHTML = externalHTML;
        */

            // TODO:  TIDY UP ALL THIS GUNK, ONCE I UNDERSTAND IT ALL WELL ENOUGH 
             
              if (kCustomSidebar !== null) {
                  kCustomSidebar.innerHTML = "Sidebar: " + externalHTML;
              }


             console.log("category " + thisCategoryID);    

/*          console.log("categories");                  // this code is all working, but the categoriesById approach is probably more efficient. 
            const categories = Site.categories; 
            console.log(categories);
            console.log("");

            console.log("category");
            const category = categories.find((c) => c.id == thisCategoryID);
            console.log(category);
            console.log("");

            console.log("kcategoryinfo");
            const categoryI = category;
            console.log(category.kcategoryinfo);
            console.log("");
*/

            console.log("thisCategory for Current Category ID ");
            const thisCategory = categoriesById[thisCategoryID]; 
            console.log(thisCategory);
            console.log("thisCategory CategoryInfo");
            const thisCategoryKInfo = thisCategory.kcategoryinfo;
            console.log(thisCategoryKInfo);
            console.log("");


            const taggingEnabled = siteSettings.tagging_enabled,
            title = siteSettings.title;

        if (taggingEnabled) {
            console.log("Yay! "+title+" has tagging enabled!")
        } else {
            console.log("Ohh nooos! "+title+"Does not allow tagging.")
        }


      //    const category = Discourse.site.categories.findBy("id", thisCategoryID);
       //   console.log("THE CATEGORY");
      //    console.log(category);
          
     //     console.log("kcategoryid:" + category["kcategoryid"];

          //   const category = this.site.categories.find(c => c.id == thisCategoryID )
          //   console.log("kcategoryid:" + category[kcategoryid];
        

            // prove that we can access & use the Custom Category field. 
            //  var kCustomCategoryField = document.getElementsByClassName('category-custom-field-textarea')[0];
            //  var kTargetCategoryField = document.getElementById('k-discovery-below');
            //  kTargetCategoryField.innerHTML = kCustomCategoryField.innerHTML;    // show custom field here, for demo purposes
                
      } else if (blnIsHomepage) {      //  NB this is closely related to 
  
            document.getElementById('k-discovery-list-controls-above').innerHTML = "";     // emptying it because it may have been set by Category page. 
            document.getElementById('k-discovery-list-container-top').innerHTML = "";     // emptying it because it may have been set by Category page. 
            // reset other shared fields also 
            // no need to reset where they are set by a subsequent line below 

            var main = document.getElementById('k-discovery-list-controls-above');
            var externalHTML = url + " Homepage type: " + strHomepageView ;
            main.innerHTML = externalHTML;
            
            if (kCustomSidebar !== null) {
                kCustomSidebar.innerHTML = externalHTML;
            }
              
      } else if (blnIsTopic) {
           
            const main = document.getElementById('k-topic-title');
            const externalHTML = url + " :  Topic id: " + thisTopicID ;
            main.innerHTML = externalHTML;
            
            if (kCustomSidebar !== null) {
                kCustomSidebar.innerHTML = externalHTML;
            }
            
            // prove that we can access & use the Custom Topic field. 
            var kCustomTopicField = document.getElementsByClassName('topic-title-custom-field-container')[0];
            var kTargetTopicField = document.getElementById('k-topic-above-suggested');
            kTargetTopicField.innerHTML = kCustomTopicField.innerHTML;  // test .. apply content of custom field to another text holder


            // NEXT, GET CURRENT TOPIC INFO .. ESPECIALLY GET CATEGORYID AND KTOPICINFO FOR CURRENT TOPIC 

                 // NOTE HOW EASY THE $.getJSON FUNCTION IS TO CALL .. LOOKS LIKE A GREAT WAY TO BUILD MY AJAX FUNCTIONS 

            /*      THIS WORKS BUT IT REQUIRES AN EXTRA CALL, I THINK 
            $.getJSON(window.location.href + '.json', function (data) {         // good that it's async. 
                const pagejson = data;
                const topicCategoryId = pagejson.category_id;

                console.log(topicCategoryId);
                });
            */


            // CAN I GET THAT VALUE USING EMBER (AVOID A CALL, AND USE APP BETTER)

            const topicController = api.container.lookup("controller:topic");
            
            if (topicController) {
                const thisTopic = topicController.get("model");
                if (thisTopic) {

                    console.log("Category Info for Current Topic");
                    console.log(thisTopic);
                    console.log(thisTopic.category.id);
                    console.log(thisTopic.category.name);

                    console.log("Lookup/Indepth Category Info for Current Topic ");
                    const thisTopicCategory = categoriesById[topic.category.id]; 
                    console.log(thisTopicCategory);
                    console.log("thisTopicCategory kcategoryinfo");
                    const thisTopicCategoryKInfo = thisTopicCategory.kcategoryinfo;
                    console.log(thisTopicCategoryKInfo);
                    console.log("");




                }
            }

      } else if (blnIsGroup) {    // currently not being set as true at all 
              const main = document.getElementById('k-group-reports-nav-item');
              main.innerHTML = thisGroupName;
              
              
      } else {    // some other page
          
      }
   
    })
  
   </script> 